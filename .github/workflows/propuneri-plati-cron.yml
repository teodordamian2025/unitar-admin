name: Propuneri Plati - Cron Job

on:
  schedule:
    # RuleazÄƒ zilnic la 07:20 GMT (09:20-10:20 AM RomÃ¢nia, Ã®n funcÈ›ie de DST)
    # 10 minute dupÄƒ propuneri Ã®ncasÄƒri (07:10 GMT)
    - cron: '20 7 * * *'
  workflow_dispatch: # Permite trigger manual din GitHub UI

jobs:
  generate-propuneri-plati:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Trigger Propuneri Plati Generate
        run: |
          echo "ğŸ’³ Triggering propuneri plÄƒÈ›i generate..."
          echo "â° Scheduled time: 07:20 GMT (09:20-10:20 AM RomÃ¢nia)"
          echo "ğŸ“… Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

          response=$(curl -s -w "\n%{http_code}" -X POST \
            https://admin.unitarproiect.eu/api/plati/propuneri/generate \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -d '{"dry_run": false, "send_notification": true}')

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo ""
          echo "ğŸ“Š HTTP Status: $http_code"
          echo "ğŸ“„ Response:"
          echo "$body" | python3 -m json.tool 2>/dev/null || echo "$body"

          if [ "$http_code" -eq 200 ]; then
            echo ""
            echo "âœ… Propuneri plÄƒÈ›i generate successfully"

            # Parse stats dacÄƒ existÄƒ
            propuneri_generate=$(echo "$body" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('propuneri_generate', 0))" 2>/dev/null || echo "N/A")
            auto_approvable=$(echo "$body" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('propuneri_auto_approvable', 0))" 2>/dev/null || echo "N/A")
            review_needed=$(echo "$body" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('propuneri_review', 0))" 2>/dev/null || echo "N/A")
            tranzactii_procesate=$(echo "$body" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('tranzactii_procesate', 0))" 2>/dev/null || echo "N/A")

            echo ""
            echo "ğŸ“ˆ Stats propuneri plÄƒÈ›i:"
            echo "   ğŸ“‹ Propuneri generate: $propuneri_generate"
            echo "   âœ… Auto-aprobabile: $auto_approvable"
            echo "   ğŸ‘€ NecesitÄƒ review: $review_needed"
            echo "   ğŸ”„ TranzacÈ›ii procesate: $tranzactii_procesate"

            # Alert dacÄƒ sunt multe propuneri noi
            if [ "${propuneri_generate:-0}" -gt 0 ] 2>/dev/null; then
              echo ""
              echo "ğŸ”” $propuneri_generate propuneri noi de verificat!"
              echo "   AcceseazÄƒ: https://admin.unitarproiect.eu/admin/financiar/propuneri-plati"
            fi
          else
            echo ""
            echo "âŒ Propuneri plÄƒÈ›i generate failed with status $http_code"
            exit 1
          fi

      - name: Health Check Summary
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ Workflow completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
