name: iApp Facturi Primite - Sync Zilnic

on:
  schedule:
    # RuleazÄƒ zilnic la 01:00 GMT (03:00-04:00 AM RomÃ¢nia, Ã®n funcÈ›ie de DST)
    - cron: '0 1 * * *'
  workflow_dispatch: # Permite trigger manual din GitHub UI

jobs:
  sync-iapp-facturi:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Trigger iApp Facturi Primite Sync
        run: |
          echo "ğŸ”„ Triggering iApp facturi primite sync..."
          echo "â° Scheduled time: 01:00 GMT (03:00-04:00 AM RomÃ¢nia)"
          echo "ğŸ“… Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

          response=$(curl -s -w "\n%{http_code}" -X POST \
            https://admin.unitarproiect.eu/api/iapp/facturi-primite/sync \
            -H "Content-Type: application/json" \
            -d '{"zile": 7}')

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo ""
          echo "ğŸ“Š HTTP Status: $http_code"
          echo "ğŸ“„ Response:"
          echo "$body" | python3 -m json.tool || echo "$body"

          if [ "$http_code" -eq 200 ]; then
            echo ""
            echo "âœ… iApp facturi primite sync completed successfully"

            # Parse stats dacÄƒ existÄƒ
            facturi_noi=$(echo "$body" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('stats', {}).get('facturi_noi', 0))" 2>/dev/null || echo "N/A")
            pdfs_descarcate=$(echo "$body" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('stats', {}).get('pdfs_descarcate', 0))" 2>/dev/null || echo "N/A")

            echo "ğŸ“ˆ Stats: Facturi noi=$facturi_noi, PDFs descÄƒrcate=$pdfs_descarcate"
          else
            echo ""
            echo "âŒ iApp facturi primite sync failed with status $http_code"
            exit 1
          fi

      - name: Health Check Summary
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ Workflow completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
